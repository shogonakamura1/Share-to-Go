# ライドシェアアプリ 詳細設計書

## 1. システム概要

### 1.1 アーキテクチャ
- **フロントエンド**: HTML, CSS(BootStrap), JavaScript (React.js)
- **バックエンド**: Python (Django)
- **データベース**: SQLite (開発環境) / PostgreSQL (本番環境)
- **認証**: Django認証システム

### 1.2 システム構成図
```
[ユーザー] → [Webブラウザ] → [Django Webサーバー] → [データベース]
```

## 2. データベース設計

### 2.1 ER図
```
User (ユーザー)
├── id (主キー)
├── username
├── email
├── password
└── created_at

RidePlan (配車計画)
├── id (主キー)
├── creator (外部キー: User)
├── title
├── description
├── departure_location
├── destination
├── departure_time
├── max_participants
├── price_per_person
├── status (active/cancelled/completed)
└── created_at

Participation (参加)
├── id (主キー)
├── user (外部キー: User)
├── ride_plan (外部キー: RidePlan)
├── pickup_location_name (乗車場所名)
├── pickup_latitude (乗車場所緯度)
├── pickup_longitude (乗車場所経度)
├── dropoff_location_name (降車場所名)
├── dropoff_latitude (降車場所緯度)
├── dropoff_longitude (降車場所経度)
├── status (pending/approved/rejected/cancelled)
└── created_at
```

### 2.2 データ型詳細
```python
# Participation モデル
class Participation(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    ride_plan = models.ForeignKey(RidePlan, on_delete=models.CASCADE)
    
    # 乗車場所情報
    pickup_location_name = models.CharField(max_length=100, verbose_name="乗車場所名")
    pickup_latitude = models.DecimalField(max_digits=9, decimal_places=6, verbose_name="乗車場所緯度")
    pickup_longitude = models.DecimalField(max_digits=9, decimal_places=6, verbose_name="乗車場所経度")
    
    # 降車場所情報
    dropoff_location_name = models.CharField(max_length=100, verbose_name="降車場所名")
    dropoff_latitude = models.DecimalField(max_digits=9, decimal_places=6, verbose_name="降車場所緯度")
    dropoff_longitude = models.DecimalField(max_digits=9, decimal_places=6, verbose_name="降車場所経度")
    
    status = models.CharField(max_length=20, choices=[
        ('pending', '承認待ち'),
        ('approved', '承認済み'),
        ('rejected', '却下'),
        ('cancelled', 'キャンセル')
    ], default='pending')
    
    created_at = models.DateTimeField(auto_now_add=True)
```

## 3. 画面設計

### 3.1 画面一覧
1. **ログイン画面** (`/login/`)
2. **ユーザー登録画面** (`/register/`)
3. **ホーム画面** (`/`)
4. **配車計画一覧画面** (`/rides/`)
5. **配車計画詳細画面** (`/rides/<id>/`)
6. **配車計画作成画面** (`/rides/create/`)
7. **マイページ** (`/profile/`)
8. **履歴画面** (`/history/`)

### 3.2 主要画面の詳細

#### ホーム画面
- 最新の配車計画一覧表示
- 検索機能（出発地・目的地・日時）
- 新規配車計画作成ボタン
- ログイン/ログアウトボタン

#### 配車計画詳細画面
- 配車計画の詳細情報表示
- 参加者一覧表示（各参加者の乗降場所も表示）
- 参加/キャンセルボタン
- 編集/削除ボタン（作成者のみ）

#### 配車計画参加画面
- 乗車場所の入力（場所名 + 地図選択）
- 降車場所の入力（場所名 + 地図選択）
- 参加リクエスト送信ボタン

#### 地図機能
- Google Maps API または OpenStreetMap を使用
- 乗降場所の地図上選択
- ルート表示機能（オプション）

## 4. API設計

### 4.1 エンドポイント一覧
```
GET    /api/rides/          # 配車計画一覧取得
POST   /api/rides/          # 配車計画作成
GET    /api/rides/{id}/     # 配車計画詳細取得
PUT    /api/rides/{id}/     # 配車計画更新
DELETE /api/rides/{id}/     # 配車計画削除
POST   /api/rides/{id}/join/    # 配車計画参加（乗降場所指定）
POST   /api/rides/{id}/cancel/  # 配車計画キャンセル
GET    /api/profile/        # ユーザープロフィール取得
GET    /api/history/        # 履歴取得
```

### 4.2 API リクエスト/レスポンス例

#### 配車計画参加 API
```json
POST /api/rides/{id}/join/
{
    "pickup_location_name": "渋谷駅東口",
    "pickup_latitude": 35.658034,
    "pickup_longitude": 139.701636,
    "dropoff_location_name": "新宿駅南口",
    "dropoff_latitude": 35.689521,
    "dropoff_longitude": 139.700704
}
```

#### 配車計画詳細取得 API
```json
GET /api/rides/{id}/
{
    "id": 1,
    "title": "渋谷→新宿",
    "description": "急ぎで移動します",
    "departure_location": "渋谷駅",
    "destination": "新宿駅",
    "departure_time": "2024-01-15T14:30:00Z",
    "max_participants": 4,
    "price_per_person": 500,
    "status": "active",
    "participants": [
        {
            "user": {
                "id": 2,
                "username": "user2"
            },
            "pickup_location_name": "渋谷駅東口",
            "pickup_latitude": 35.658034,
            "pickup_longitude": 139.701636,
            "dropoff_location_name": "新宿駅南口",
            "dropoff_latitude": 35.689521,
            "dropoff_longitude": 139.700704,
            "status": "approved"
        }
    ]
}
```

## 5. セキュリティ設計

### 5.1 認証・認可
- Django認証システムを使用
- セッション管理
- CSRF保護
- パスワードハッシュ化

### 5.2 データ保護
- 個人情報の暗号化
- SQLインジェクション対策
- XSS対策

## 6. 開発環境・ツール

### 6.1 開発環境
- Python 3.11+
- Django 4.2+
- Node.js 18+
- React 18+

### 6.2 開発ツール
- Git (バージョン管理)
- VS Code (エディタ)
- Django Debug Toolbar (デバッグ)
- pytest (テスト)

## 7. 実装順序

### Phase 1: 基本機能
1. Djangoプロジェクト作成
2. ユーザー認証機能
3. 基本的なCRUD操作
4. データベース設計・実装

### Phase 2: フロントエンド
1. Reactプロジェクト作成
2. 基本画面実装
3. API連携

### Phase 3: 高度な機能
1. 検索機能
2. 通知機能
3. 評価機能

## 8. テスト計画

### 8.1 テスト種別
- 単体テスト (pytest)
- 統合テスト
- E2Eテスト (Selenium)

### 8.2 テスト対象
- API エンドポイント
- データベース操作
- 認証機能
- 主要なユーザーフロー 